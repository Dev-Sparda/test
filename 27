import polars as pl
import duckdb
from datetime import datetime


class ValidadorSLA:

    def __init__(self, ruta_excel, schema):
        self.ruta_excel = ruta_excel
        self.schema = schema
        self.conn = duckdb.connect(":memory:")
        self.df = None

        self.conn.execute("""
            CREATE TABLE errores_estructura (
                error_mensaje VARCHAR,
                fecha TIMESTAMP
            )
        """)

    def cargar_y_validar(self):

        try:
            # üî¥ Tipado fuerte desde la carga
            self.df = pl.read_excel(
                self.ruta_excel,
                schema=self.schema  # ‚Üê cast fuerte aqu√≠
            )

            print("‚úì Archivo v√°lido estructuralmente")

        except Exception as e:

            print("‚ùå Error estructural en la carga. Archivo rechazado.")

            self.conn.execute(
                "INSERT INTO errores_estructura VALUES (?, ?)",
                (str(e), datetime.now())
            )

            return False

        # Si lleg√≥ aqu√≠, cumple estructura
        self.conn.register("datos", self.df.to_arrow())
        print("‚úì Registrado en DuckDB")

        return True

    def validar_negocio(self, query):
        return self.conn.execute(query).pl()

    def ver_errores(self):
        return self.conn.execute(
            "SELECT * FROM errores_estructura"
        ).fetchdf()

    def cerrar(self):
        self.conn.close()
