import requests
import pandas as pd
from datetime import datetime

def descargar_tipo_cambio_directo(token, serie="SF43718", fecha_inicio=None, fecha_fin=None):
    """
    Descarga tipo de cambio usando requests directamente
    """
    
    # Construir URL base
    base_url = "https://www.banxico.org.mx/SieAPIRest/service/v1"
    
    if fecha_inicio and fecha_fin:
        # Consulta por rango de fechas
        url = f"{base_url}/series/{serie}/datos/{fecha_inicio}/{fecha_fin}"
    else:
        # Consulta completa
        url = f"{base_url}/series/{serie}/datos"
    
    headers = {
        "Bmx-Token": token,
        "Accept": "application/json"  # Tambi√©n soporta XML [citation:2]
    }
    
    print(f"üåê Consultando: {url}")
    
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        
        data = response.json()
        
        # Procesar respuesta
        series_data = data['bmx']['series'][0]
        datos = series_data['datos']
        
        # Convertir a DataFrame
        df = pd.DataFrame(datos)
        df['fecha'] = pd.to_datetime(df['fecha'], format='%d/%m/%Y')
        df['dato'] = pd.to_numeric(df['dato'])
        df = df.sort_values('fecha')
        
        print(f"‚úÖ {len(df)} registros obtenidos")
        return df
        
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error en la petici√≥n: {e}")
        return None
    except KeyError as e:
        print(f"‚ùå Error procesando respuesta JSON: {e}")
        return None

# Uso
TOKEN = "tu_token_aqui"
df = descargar_tipo_cambio_directo(TOKEN, fecha_inicio="2024-01-01", fecha_fin="2024-12-31")
if df is not None:
    print(df.head())
