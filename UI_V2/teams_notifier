# teams_notifier.py
import requests
from db_manager import get_nombre_por_clave, get_correo_por_clave

# üîë Tu webhook aqu√≠
TEAMS_WEBHOOK_URL = "https://tu-webhook-real-aqui..."

def enviar_alertas_por_responsable(fases):
    """
    Env√≠a una tarjeta de Teams por cada responsable con fases vencidas.
    :param fases: lista de filas sqlite3.Row con claves:
                  FASE, REPORTE, FECHA_FIN, CLAVE_RESPONSABLE, ID_DESARROLLO
    :return: dict con resultados por responsable
    """
    if not fases:
        return {}

    # Agrupar fases por responsable
    from collections import defaultdict
    agrupado = defaultdict(list)
    for f in fases:
        agrupado[f["CLAVE_RESPONSABLE"]].append(f)

    resultados = {}
    
    for clave_responsable, fases_lista in agrupado.items():
        exito = enviar_tarjeta_responsable(clave_responsable, fases_lista)
        resultados[clave_responsable] = exito
    
    return resultados

def enviar_tarjeta_responsable(clave_responsable, fases):
    """Env√≠a una tarjeta para un responsable espec√≠fico."""
    nombre = get_nombre_por_clave(clave_responsable)
    correo = get_correo_por_clave(clave_responsable)
    
    # Construir menci√≥n (solo si hay correo)
    mencion = f"<at>{nombre}</at>" if correo else nombre
    
    body = [
        {
            "type": "TextBlock",
            "text": f"üö® **Fases vencidas** para {mencion}",
            "size": "Large",
            "weight": "Bolder",
            "color": "Attention",
            "wrap": True
        }
    ]
    
    # Agregar cada fase
    for f in fases[:10]:  # L√≠mite razonable
        body.append({
            "type": "FactSet",
            "facts": [
                {"title": "Fase", "value": f["FASE"]},
                {"title": "Desarrollo", "value": f["REPORTE"]},
                {"title": "Fecha l√≠mite", "value": f["FECHA_FIN"]},
                {"title": "ID Desarrollo", "value": str(f["ID_DESARROLLO"])}
            ]
        })
    
    if len(fases) > 10:
        body.append({
            "type": "TextBlock",
            "text": f"+{len(fases)-10} fases adicionales",
            "italic": True,
            "wrap": True
        })

    # Si hay correo, incluir en 'msteams' para menci√≥n
    msteams = None
    if correo:
        msteams = {
            "entities": [{
                "type": "mention",
                "text": f"<at>{nombre}</at>",
                "mentioned": {
                    "id": correo,
                    "name": nombre
                }
            }]
        }

    adaptive_card = {
        "type": "message",
        "attachments": [{
            "contentType": "application/vnd.microsoft.card.adaptive",
            "contentUrl": None,
            "content": {
                "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.2",
                "body": body,
                "msteams": msteams  # ‚Üê Habilita menciones
            }
        }]
    }

    try:
        response = requests.post(TEAMS_WEBHOOK_URL, json=adaptive_card, timeout=10)
        return response.status_code == 202
    except Exception as e:
        print(f"‚ùå Error al enviar a {nombre}: {e}")
        return False

