# ui_detalle.py
import sqlite3
import customtkinter as ctk
from datetime import date
from db_manager import get_desarrollo_by_id, get_fases_by_desarrollo, get_nombre_por_clave
from utils import create_textbox_with_placeholder

def open_detalle_window(parent, id_desarrollo):
    top = ctk.CTkToplevel(parent)
    top.title(f"üìù Editar Desarrollo #{id_desarrollo}")
    top.geometry("800x850")
    top.lift()
    top.focus_force()
    top.attributes("-topmost", True)
    top.after(100, lambda: top.attributes("-topmost", False))

    dev = get_desarrollo_by_id(id_desarrollo)
    if not dev:
        ctk.CTkLabel(top, text="Desarrollo no encontrado", text_color="red").pack(pady=20)
        return

    nombre_responsable = get_nombre_por_clave(dev['CLAVE_RESPONSABLE'])

    ctk.CTkLabel(top, text=f"Desarrollo #{id_desarrollo} - {dev['REPORTE']}", font=("Arial", 16, "bold")).pack(pady=10)

    # Info general
    info_frame = ctk.CTkFrame(top)
    info_frame.pack(fill="x", padx=20, pady=10)

    ctk.CTkLabel(info_frame, text="Responsable:").grid(row=0, column=0, sticky="w", padx=5, pady=3)
    ctk.CTkLabel(info_frame, text=nombre_responsable).grid(row=0, column=1, sticky="w", padx=5, pady=3)

    ctk.CTkLabel(info_frame, text="Solicitante:").grid(row=1, column=0, sticky="w", padx=5, pady=3)
    ctk.CTkLabel(info_frame, text=dev['USUARIO_SOLICITANTE']).grid(row=1, column=1, sticky="w", padx=5, pady=3)

    ctk.CTkLabel(info_frame, text="Fecha Inicio:").grid(row=2, column=0, sticky="w", padx=5, pady=3)
    ctk.CTkLabel(info_frame, text=dev['FECHA_INICIO']).grid(row=2, column=1, sticky="w", padx=5, pady=3)

    ctk.CTkLabel(info_frame, text="Tecnolog√≠a:").grid(row=3, column=0, sticky="w", padx=5, pady=3)
    ctk.CTkLabel(info_frame, text=dev['TECNOLOGIA_USADA']).grid(row=3, column=1, sticky="w", padx=5, pady=3)

    # Estatus general
    ctk.CTkLabel(info_frame, text="Estatus General:").grid(row=4, column=0, sticky="w", padx=5, pady=8)
    estatus_opciones = ["En an√°lisis", "En desarrollo", "Pausado", "Finalizado"]
    combo_estatus_general = ctk.CTkComboBox(info_frame, values=estatus_opciones, width=200)
    combo_estatus_general.set(dev['ESTATUS'])
    combo_estatus_general.grid(row=4, column=1, sticky="w", padx=5, pady=8)

    def guardar_estatus_general():
        nuevo_estatus = combo_estatus_general.get()
        conn = sqlite3.connect("desarrollos.db")
        cursor = conn.cursor()
        cursor.execute("UPDATE DESARROLLOS SET ESTATUS = ? WHERE ID = ?", (nuevo_estatus, id_desarrollo))
        conn.commit()
        conn.close()
        combo_estatus_general.configure(border_color="green")
        info_frame.after(2000, lambda: combo_estatus_general.configure(border_color="#565B5E"))

    ctk.CTkButton(info_frame, text="üíæ Guardar", command=guardar_estatus_general, width=120).grid(row=4, column=2, padx=10)

    # Prioridad
    ctk.CTkLabel(info_frame, text="Prioridad:").grid(row=5, column=0, sticky="w", padx=5, pady=8)
    prioridad_opciones = ["Baja", "Media", "Alta", "Cr√≠tica"]
    combo_prioridad = ctk.CTkComboBox(info_frame, values=prioridad_opciones, width=200)
    combo_prioridad.set(dev['PRIORIDAD'] or "Media")
    combo_prioridad.grid(row=5, column=1, sticky="w", padx=5, pady=8)

    def guardar_prioridad():
        nueva = combo_prioridad.get()
        conn = sqlite3.connect("desarrollos.db")
        cursor = conn.cursor()
        cursor.execute("UPDATE DESARROLLOS SET PRIORIDAD = ? WHERE ID = ?", (nueva, id_desarrollo))
        conn.commit()
        conn.close()
        combo_prioridad.configure(border_color="green")
        info_frame.after(2000, lambda: combo_prioridad.configure(border_color="#565B5E"))

    ctk.CTkButton(info_frame, text="üíæ Guardar", command=guardar_prioridad, width=120).grid(row=5, column=2, padx=10)

    # === A√±adir nueva fase ===
    def agregar_nueva_fase():
        form_fase = ctk.CTkToplevel(top)
        form_fase.title("Nueva Fase")
        form_fase.geometry("650x500")
        form_fase.lift()
        form_fase.focus_force()
        form_fase.attributes("-topmost", True)
        form_fase.after(100, lambda: form_fase.attributes("-topmost", False))

        ctk.CTkLabel(form_fase, text="Fase:").grid(row=0, column=0, padx=10, pady=8, sticky="w")
        entry_fase = ctk.CTkEntry(form_fase, width=300)
        entry_fase.grid(row=0, column=1, padx=10, pady=8)

        ctk.CTkLabel(form_fase, text="Descripci√≥n:").grid(row=1, column=0, padx=10, pady=8, sticky="nw")
        txt_desc = create_textbox_with_placeholder(form_fase, "Describe la fase...", width=400, height=80)
        txt_desc.grid(row=1, column=1, padx=10, pady=8)

        ctk.CTkLabel(form_fase, text="Fecha Inicio:").grid(row=2, column=0, padx=10, pady=8, sticky="w")
        entry_ini = ctk.CTkEntry(form_fase, width=150)
        entry_ini.insert(0, str(date.today()))
        entry_ini.grid(row=2, column=1, padx=10, pady=8, sticky="w")

        ctk.CTkLabel(form_fase, text="Fecha Fin:").grid(row=3, column=0, padx=10, pady=8, sticky="w")
        entry_fin = ctk.CTkEntry(form_fase, width=150)
        entry_fin.grid(row=3, column=1, padx=10, pady=8, sticky="w")

        ctk.CTkLabel(form_fase, text="Estatus:").grid(row=4, column=0, padx=10, pady=8, sticky="w")
        opciones_estatus = ["En an√°lisis", "En desarrollo", "Pausado", "Finalizada"]
        combo_estatus = ctk.CTkComboBox(form_fase, values=opciones_estatus, width=180)
        combo_estatus.set("En desarrollo")
        combo_estatus.grid(row=4, column=1, padx=10, pady=8, sticky="w")

        ctk.CTkLabel(form_fase, text="Comentarios:").grid(row=5, column=0, padx=10, pady=8, sticky="w")
        entry_com = ctk.CTkEntry(form_fase, width=400)
        entry_com.grid(row=5, column=1, padx=10, pady=8)

        def guardar_nueva_fase():
            fase_nombre = entry_fase.get().strip()
            if not fase_nombre:
                entry_fase.configure(border_color="red")
                form_fase.after(2000, lambda: entry_fase.configure(border_color="#565B5E"))
                return

            desc_text = txt_desc.get("1.0", "end-1c").strip()
            if hasattr(txt_desc, "has_placeholder") and txt_desc.has_placeholder:
                desc_text = ""

            conn = sqlite3.connect("desarrollos.db")
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO FASES (ID_DESARROLLO, FASE, DESCRIPCION, FECHA_INICIO, FECHA_FIN, COMENTARIOS, ESTATUS)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (
                id_desarrollo,
                fase_nombre,
                desc_text,
                entry_ini.get(),
                entry_fin.get(),
                entry_com.get(),
                combo_estatus.get()
            ))
            conn.commit()
            conn.close()
            form_fase.destroy()
            top.destroy()
            open_detalle_window(parent, id_desarrollo)

        ctk.CTkButton(form_fase, text="üíæ Guardar Nueva Fase", command=guardar_nueva_fase, height=40).grid(row=6, column=0, columnspan=2, pady=20)

    ctk.CTkButton(top, text="‚ûï A√±adir Nueva Fase", command=agregar_nueva_fase).pack(pady=15)

    # === Fases existentes ===
    ctk.CTkLabel(top, text="Fases existentes:", font=("Arial", 12, "bold")).pack(pady=(10,5))

    fase_frame = ctk.CTkScrollableFrame(top, height=400)
    fase_frame.pack(fill="both", expand=True, padx=20, pady=10)

    fases = get_fases_by_desarrollo(id_desarrollo)
    opciones_estatus = ["En an√°lisis", "En desarrollo", "Pausado", "Finalizada"]

    for fase in fases:
        frame = ctk.CTkFrame(fase_frame)
        frame.pack(fill="x", padx=5, pady=12)

        ctk.CTkLabel(frame, text=f"üîπ {fase['FASE']}", font=("Arial", 12, "bold")).pack(anchor="w", padx=5, pady=2)

        # Descripci√≥n editable
        ctk.CTkLabel(frame, text="Descripci√≥n:").pack(anchor="w", padx=5, pady=(10,2))
        txt_desc_edit = ctk.CTkTextbox(frame, width=600, height=70)
        txt_desc_edit.pack(anchor="w", padx=5, pady=2)
        txt_desc_edit.insert("1.0", fase['DESCRIPCION'] or "")

        # Fechas editables
        fecha_frame = ctk.CTkFrame(frame)
        fecha_frame.pack(anchor="w", padx=5, pady=2)
        ctk.CTkLabel(fecha_frame, text="Fecha Inicio:").grid(row=0, column=0, padx=5, pady=2)
        entry_fecha_ini = ctk.CTkEntry(fecha_frame, width=120)
        entry_fecha_ini.insert(0, fase['FECHA_INICIO'] or "")
        entry_fecha_ini.grid(row=0, column=1, padx=5, pady=2)
        ctk.CTkLabel(fecha_frame, text="Fecha Fin:").grid(row=0, column=2, padx=5, pady=2)
        entry_fecha_fin = ctk.CTkEntry(fecha_frame, width=120)
        entry_fecha_fin.insert(0, fase['FECHA_FIN'] or "")
        entry_fecha_fin.grid(row=0, column=3, padx=5, pady=2)

        # Estatus
        ctk.CTkLabel(frame, text="Estatus:").pack(anchor="w", padx=5, pady=(10,2))
        combo_estatus = ctk.CTkComboBox(frame, values=opciones_estatus, width=180)
        combo_estatus.set(fase['ESTATUS'])
        combo_estatus.pack(anchor="w", padx=5, pady=2)

        # Comentarios
        ctk.CTkLabel(frame, text="Comentarios:").pack(anchor="w", padx=5, pady=(10,2))
        entry_comentario = ctk.CTkEntry(frame, width=600)
        entry_comentario.insert(0, fase['COMENTARIOS'] or "")
        entry_comentario.pack(anchor="w", padx=5, pady=2)

        def guardar_cambio(fase_id=fase['ID'], txt_desc=txt_desc_edit, combo=combo_estatus, entry_com=entry_comentario, entry_ini=entry_fecha_ini, entry_fin=entry_fecha_fin):
            desc = txt_desc.get("1.0", "end-1c").strip()
            estatus = combo.get()
            comentarios = entry_com.get().strip()
            fecha_ini = entry_ini.get().strip()
            fecha_fin = entry_fin.get().strip()

            conn = sqlite3.connect("desarrollos.db")
            cursor = conn.cursor()
            cursor.execute("""
                UPDATE FASES SET DESCRIPCION = ?, ESTATUS = ?, COMENTARIOS = ?, FECHA_INICIO = ?, FECHA_FIN = ?
                WHERE ID = ?
            """, (desc, estatus, comentarios, fecha_ini, fecha_fin, fase_id))
            conn.commit()
            conn.close()

            txt_desc.configure(border_color="green")
            entry_com.configure(border_color="green")
            frame.after(2000, lambda: [
                txt_desc.configure(border_color="#565B5E"),
                entry_com.configure(border_color="#565B5E")
            ])

        ctk.CTkButton(frame, text="üíæ Guardar Cambios", command=guardar_cambio).pack(pady=10)

    ctk.CTkButton(top, text="Cerrar", command=top.destroy).pack(pady=15)
