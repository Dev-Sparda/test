WITH fecha_anterior AS (
    SELECT MAX(FECHA_DATOS) as FECHA_ANTERIOR
    FROM ENTRADAS 
    WHERE FECHA_DATOS < 'tu_fecha_actual'
),
datos_n_entradas AS (
    SELECT 
        e.SUBSIDIARIA,
        SUM(e.MONTO) as MONTO_N
    FROM ENTRADAS e
    WHERE e.FECHA_DATOS IN ('tu_fecha_actual', (SELECT FECHA_ANTERIOR FROM fecha_anterior))
        AND e.CONCEPTO IN ('15964', '15701')
    GROUP BY e.SUBSIDIARIA
),
datos_n_salidas AS (
    SELECT 
        s.SUBSIDIARIA,
        SUM(s.MONTO) as MONTO_N
    FROM SALIDAS s
    WHERE s.FECHA_DATOS IN ('tu_fecha_actual', (SELECT FECHA_ANTERIOR FROM fecha_anterior))
        AND s.CONCEPTO IN ('10386', '10393')
    GROUP BY s.SUBSIDIARIA
),
datos_n_completo AS (
    SELECT 
        SUBSIDIARIA,
        SUM(MONTO_N) as MONTO_N
    FROM (
        SELECT SUBSIDIARIA, MONTO_N FROM datos_n_entradas
        UNION ALL
        SELECT SUBSIDIARIA, MONTO_N FROM datos_n_salidas
    )
    GROUP BY SUBSIDIARIA
),
datos_o AS (
    SELECT 
        e.SUBSIDIARIA,
        SUM(e.MONTO) as MONTO_O
    FROM ENTRADAS e
    WHERE e.FECHA_DATOS = 'tu_fecha_actual'
        AND e.CONCEPTO = '10377'
    GROUP BY e.SUBSIDIARIA
),
combinacion_base AS (
    SELECT DISTINCT SUBSIDIARIA 
    FROM (
        SELECT SUBSIDIARIA FROM ENTRADAS WHERE FECHA_DATOS = 'tu_fecha_actual'
        UNION
        SELECT SUBSIDIARIA FROM SALIDAS WHERE FECHA_DATOS = 'tu_fecha_actual'
    )
)
SELECT 
    'tu_fecha_actual' AS FECHA_DATOS,
    cb.SUBSIDIARIA,
    '15964+15701(ENTRADAS)+10386+10393(SALIDAS)' AS CONCEPTO_N,
    COALESCE(dn.MONTO_N, 0) AS MONTO_N,
    '10377' AS CONCEPTO_O,
    COALESCE(do.MONTO_O, 0) AS MONTO_O,
    CASE 
        WHEN COALESCE(dn.MONTO_N, 0) > 0 AND COALESCE(do.MONTO_O, 0) > 0 THEN 1
        WHEN COALESCE(dn.MONTO_N, 0) > 0 AND COALESCE(do.MONTO_O, 0) <= 0 THEN 2
        ELSE 1  -- Si N <= 0, no aplica la validaciÃ³n (cumple)
    END AS RESULTADO
FROM combinacion_base cb
LEFT JOIN datos_n_completo dn ON cb.SUBSIDIARIA = dn.SUBSIDIARIA
LEFT JOIN datos_o do ON cb.SUBSIDIARIA = do.SUBSIDIARIA;
