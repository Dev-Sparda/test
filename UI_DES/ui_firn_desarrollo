# ui_form_desarrollo.py
import customtkinter as ctk
from datetime import date
from catalog_db import get_responsables_con_correo, get_usuarios_solicitantes
from db_manager import save_desarrollo, save_fase
from utils import create_textbox_with_placeholder

class NuevoDesarrolloForm(ctk.CTkToplevel):
    def __init__(self, parent, on_save):
        super().__init__(parent)
        self.title("Nuevo Desarrollo")
        self.geometry("700x700")  # Aumentamos altura

        # Asegurar que la ventana aparezca al frente
        self.lift()
        self.focus_force()
        self.attributes("-topmost", True)
        self.after(100, lambda: self.attributes("-topmost", False))

        self.on_save = on_save
        self.fases_widgets = []
        self.responsable_correo_map = {}

        # Frame scrollable principal para todo el contenido
        self.scroll_frame = ctk.CTkScrollableFrame(self)
        self.scroll_frame.pack(fill="both", expand=True, padx=10, pady=10)

        self.create_form()

    def create_form(self):
        # Cargar datos del cat√°logo
        responsables_data = get_responsables_con_correo()
        self.responsable_correo_map = {r[0]: r[1] for r in responsables_data}
        nombres_responsables = [r[0] for r in responsables_data]
        nombres_solicitantes = get_usuarios_solicitantes()

        self.entries = {}
        current_row = 0

        # === Campos del desarrollo ===
        fields = [
            ("Reporte", "entry"),
            ("Responsable Desarrollo", "combo_resp"),
            ("Usuario Solicitante", "combo_solic"),
            ("Tecnolog√≠a Usada", "entry"),
            ("Fecha Inicio", "date"),
            ("Estatus", "combo_estatus_dev")
        ]

        for label, tipo in fields:
            ctk.CTkLabel(self.scroll_frame, text=label).grid(row=current_row, column=0, sticky="w", padx=10, pady=5)
            if tipo == "entry":
                widget = ctk.CTkEntry(self.scroll_frame, width=400)
                if label == "Reporte":
                    widget.focus()
            elif tipo == "date":
                widget = ctk.CTkEntry(self.scroll_frame, width=400)
                widget.insert(0, str(date.today()))
            elif tipo == "combo_resp":
                widget = ctk.CTkComboBox(self.scroll_frame, values=nombres_responsables, width=400)
            elif tipo == "combo_solic":
                widget = ctk.CTkComboBox(self.scroll_frame, values=nombres_solicitantes, width=400)
            elif tipo == "combo_estatus_dev":
                opciones = ["En an√°lisis", "En desarrollo", "Pausado", "Finalizado"]
                widget = ctk.CTkComboBox(self.scroll_frame, values=opciones, width=400)
                widget.set("En an√°lisis")
            self.entries[label] = widget
            widget.grid(row=current_row, column=1, padx=10, pady=5)
            current_row += 1

        # === Bot√≥n A√±adir Fase ===
        self.btn_add_fase = ctk.CTkButton(
            self.scroll_frame,
            text="‚ûï A√±adir Fase",
            command=self.add_fase_section,
            height=35
        )
        self.btn_add_fase.grid(row=current_row, column=0, columnspan=2, pady=15)
        current_row += 1

        # === Frame para fases (dentro del scroll principal) ===
        self.fases_frame = ctk.CTkFrame(self.scroll_frame)
        self.fases_frame.grid(row=current_row, column=0, columnspan=2, sticky="ew", padx=5, pady=10)
        current_row += 1

        # === Bot√≥n Guardar ===
        self.btn_save = ctk.CTkButton(
            self.scroll_frame,
            text="üíæ Guardar Desarrollo",
            command=self.save,
            height=40,
            font=("Arial", 14, "bold")
        )
        self.btn_save.grid(row=current_row, column=0, columnspan=2, pady=20)

        # Configurar expansi√≥n de columnas
        self.scroll_frame.columnconfigure(1, weight=1)

    def add_fase_section(self):
        frame = ctk.CTkFrame(self.fases_frame)
        frame.pack(fill="x", padx=5, pady=10)

        # Fila 1: Fase
        ctk.CTkLabel(frame, text="Fase:").grid(row=0, column=0, sticky="w", padx=5, pady=5)
        ent_fase = ctk.CTkEntry(frame, width=200)
        ent_fase.grid(row=0, column=1, padx=5, pady=5)

        # Fila 2: Descripci√≥n (ahora CTkTextbox)
        ctk.CTkLabel(frame, text="Descripci√≥n:").grid(row=1, column=0, sticky="nw", padx=5, pady=5)
        txt_desc = ctk.CTkTextbox(frame, width=400, height=60)
        txt_desc.grid(row=1, column=1, columnspan=3, padx=5, pady=5, sticky="w")

        # Fila 3: Fechas
        ctk.CTkLabel(frame, text="Fecha Inicio:").grid(row=2, column=0, sticky="w", padx=5, pady=5)
        ent_ini = ctk.CTkEntry(frame, width=120)
        ent_ini.grid(row=2, column=1, padx=5, pady=5)

        ctk.CTkLabel(frame, text="Fecha Fin:").grid(row=2, column=2, sticky="w", padx=5, pady=5)
        ent_fin = ctk.CTkEntry(frame, width=120)
        ent_fin.grid(row=2, column=3, padx=5, pady=5)

        # Fila 4: Estatus y Comentarios
        ctk.CTkLabel(frame, text="Estatus:").grid(row=3, column=0, sticky="w", padx=5, pady=5)
        opciones_estatus = ["En an√°lisis", "En desarrollo", "Pausado", "Finalizada"]
        combo_estatus = ctk.CTkComboBox(frame, values=opciones_estatus, width=150)
        combo_estatus.set("En desarrollo")
        combo_estatus.grid(row=3, column=1, padx=5, pady=5)

        ctk.CTkLabel(frame, text="Comentarios:").grid(row=3, column=2, sticky="w", padx=5, pady=5)
        ent_com = ctk.CTkEntry(frame, width=250)
        ent_com.grid(row=3, column=3, padx=5, pady=5)

        self.fases_widgets.append({
            "FASE": ent_fase,
            "DESCRIPCION": txt_desc,  # ‚Üê ahora es un Textbox
            "FECHA_INICIO": ent_ini,
            "FECHA_FIN": ent_fin,
            "COMENTARIOS": ent_com,
            "ESTATUS": combo_estatus
        })


    def save(self):
        responsable = self.entries["Responsable Desarrollo"].get()
        solicitante = self.entries["Usuario Solicitante"].get()
        if not responsable or not solicitante:
            error = ctk.CTkLabel(
                self.scroll_frame,
                text="‚ö†Ô∏è Selecciona responsable y solicitante",
                text_color="red"
            )
            error.grid(row=1000, column=0, columnspan=2, pady=5)
            self.after(3000, error.destroy)
            return

        data = {
            "REPORTE": self.entries["Reporte"].get(),
            "RESPONSABLE_DESARROLLO": responsable,
            "USUARIO_SOLICITANTE": solicitante,
            "TECNOLOGIA_USADA": self.entries["Tecnolog√≠a Usada"].get(),
            "FECHA_INICIO": self.entries["Fecha Inicio"].get(),
            "ESTATUS": self.entries["Estatus"].get(),
        }
        id_dev = save_desarrollo(data)

        for fase_widget in self.fases_widgets:
            fase_data = {
                "FASE": fase_widget["FASE"].get(),
                "DESCRIPCION": fase_widget["DESCRIPCION"].get("1.0", "end-1c").strip(),
                "FECHA_INICIO": fase_widget["FECHA_INICIO"].get(),
                "FECHA_FIN": fase_widget["FECHA_FIN"].get(),
                "COMENTARIOS": fase_widget["COMENTARIOS"].get(),
                "ESTATUS": fase_widget["ESTATUS"].get() or "En desarrollo"
            }
            save_fase(id_dev, fase_data)

        self.on_save()
        self.destroy()
