# ui_main.py
import customtkinter as ctk
from db_manager import get_all_desarrollos, get_fases_vencidas_sin_finalizar
from catalog_db import get_responsables_con_correo
from email_notifier import enviar_alerta_correo
from ui_detalle import open_detalle_window

class MainView(ctk.CTkFrame):
    def __init__(self, parent, on_new_click):
        super().__init__(parent)
        self.on_new_click = on_new_click
        self.create_widgets()
        self.load_data()

    def create_widgets(self):
        btn_frame = ctk.CTkFrame(self)
        btn_frame.pack(pady=10)

        self.btn_new = ctk.CTkButton(btn_frame, text="üÜï Nuevo Desarrollo", command=self.on_new_click)
        self.btn_new.pack(side="left", padx=5)

        self.btn_alert = ctk.CTkButton(btn_frame, text="üîç Verificar fases vencidas", command=self.verificar_y_notificar)
        self.btn_alert.pack(side="left", padx=5)

        self.table_frame = ctk.CTkScrollableFrame(self)
        self.table_frame.pack(fill="both", expand=True, padx=10, pady=5)

        headers = ["ID", "Reporte", "Responsable", "Estatus", "Inicio", "Tecnolog√≠a"]
        for i, h in enumerate(headers):
            lbl = ctk.CTkLabel(self.table_frame, text=h, font=("Arial", 12, "bold"))
            lbl.grid(row=0, column=i, padx=5, pady=5)

    def load_data(self):
        for widget in self.table_frame.winfo_children():
            if int(widget.grid_info()["row"]) > 0:
                widget.destroy()

        desarrollos = get_all_desarrollos()
        for row_idx, d in enumerate(desarrollos, start=1):
            fields = [
                str(d["ID"]),
                d["REPORTE"] or "",
                d["RESPONSABLE_DESARROLLO"] or "",
                d["ESTATUS"] or "",
                d["FECHA_INICIO"] or "",
                d["TECNOLOGIA_USADA"] or ""
            ]
            for col_idx, val in enumerate(fields):
                label = ctk.CTkLabel(self.table_frame, text=val, cursor="hand2")
                label.grid(row=row_idx, column=col_idx, padx=5, pady=3)
                label.bind("<Button-1>", lambda e, dev_id=d["ID"]: open_detalle_window(self, dev_id))

    def verificar_y_notificar(self):
        fases = get_fases_vencidas_sin_finalizar()
        if not fases:
            status = ctk.CTkLabel(self, text="‚úÖ No hay fases vencidas.", text_color="green")
            status.pack()
            self.after(3000, status.destroy)
            return

        # Cargar mapa responsable ‚Üí correo
        responsables_correo = {r[0]: r[1] for r in get_responsables_con_correo()}

        for fase in fases:
            responsable = fase["RESPONSABLE_DESARROLLO"]
            correo = responsables_correo.get(responsable)
            if correo:
                enviar_alerta_correo(correo, responsable, fase)
            else:
                print(f"‚ö†Ô∏è Correo no encontrado para: {responsable}")

        status = ctk.CTkLabel(self, text=f"üìß Alertas enviadas para {len(fases)} fase(s) vencida(s).", text_color="orange")
        status.pack()
        self.after(4000, status.destroy)
