def run_pipeline(root_window):
    """
    Ejecuta todo el pipeline de generaci√≥n de reportes.
    root_window: necesario para filedialog desde una app CTk.
    """
    conn = sqlite3.connect(DB_PATH)

    try:
        # 1. Cargar movimientos y unir con cat√°logo para obtener CLAVE_BANXICO
        df_mov = pd.read_sql("""
            SELECT 
                m.CONTRAPARTE,
                m.EMISION,
                m.TITULOS,
                m.ISIN,
                m.ENVIO_RECEPCION,
                c.CLAVE_BANXICO
            FROM MOVIMIENTOS m
            LEFT JOIN CAT_CONTRAPARTES c ON m.CONTRAPARTE = c.CONTRAPARTE
        """, conn)

        if df_mov.empty:
            messagebox.showwarning("Advertencia", "No hay movimientos cargados.")
            return

        # Asegurar que TITULOS sea num√©rico
        df_mov['TITULOS'] = pd.to_numeric(df_mov['TITULOS'], errors='coerce')

        # 2. Agrupar por CLAVE_BANXICO + EMISION (no por CONTRAPARTE)
        df_agrupado = df_mov.groupby(['CLAVE_BANXICO', 'EMISION'], as_index=False).agg({
            'TITULOS': 'sum',
            'ISIN': 'first',
            'ENVIO_RECEPCION': 'first'
        })

        # 3. Eliminar posiciones neteadas a cero
        df_agrupado = df_agrupado[df_agrupado['TITULOS'] != 0].copy()



        if df_agrupado.empty:
            messagebox.showinfo("Informaci√≥n", "No hay posiciones abiertas (todo neteado a cero).")
            return

        # 4. Volver a unir con CAT_CONTRAPARTES para recuperar CONTRAPARTE
        # (por si hay m√°s de una contraparte por CLAVE_BANXICO, tomamos la primera)
        df_final = df_agrupado.merge(
            df_mov[['CLAVE_BANXICO', 'CONTRAPARTE']].drop_duplicates(),
            on='CLAVE_BANXICO',
            how='left'
        )

        # 5. Clasificar como nacional o extranjero
        df_final['TIPO'] = df_final['EMISION'].apply(classify_emision)
        total_titulos = df_final['TITULOS'].sum()
        messagebox.showinfo("Total", f"Suma total de t√≠tulos (neto): {total_titulos:,}")

import requests
import pandas as pd
from datetime import datetime

def fmp_data_mes_actual(symbol, api_key="demo"):
    """
    Obtiene datos hist√≥ricos del mes actual de Financial Modeling Prep
    """
    try:
        url = f"https://financialmodelingprep.com/api/v3/historical-price-full/{symbol}"
        params = {'apikey': api_key}
        
        print(f"üì° Descargando datos de {symbol}...")
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if 'historical' in data and data['historical']:
            df = pd.DataFrame(data['historical'])
            df['date'] = pd.to_datetime(df['date'])
            df.set_index('date', inplace=True)
            
            # Filtrar solo el mes actual
            mes_actual = datetime.now().month
            a√±o_actual = datetime.now().year
            
            df_mes_actual = df[
                (df.index.month == mes_actual) & 
                (df.index.year == a√±o_actual)
            ]
            
            print(f"‚úÖ {symbol}: {len(df_mes_actual)} registros del mes actual")
            return df_mes_actual.sort_index(ascending=False)  # M√°s reciente primero
            
        else:
            print(f"‚ùå No hay datos para {symbol}")
            return None
            
    except Exception as e:
        print(f"‚ùå Error: {e}")
        return None

# Probar con m√∫ltiples acciones
def obtener_datos_multiples(symbols):
    """
    Obtiene datos del mes actual para m√∫ltiples s√≠mbolos
    """
    datos = {}
    
    for symbol in symbols:
        df = fmp_data_mes_actual(symbol)
        if df is not None:
            datos[symbol] = df
    
    return datos

# Ejemplo de uso
if __name__ == "__main__":
    # Lista de acciones que te interesen
    mis_acciones = ["AAPL", "MSFT", "GOOGL", "TSLA", "META"]
    
    print("üöÄ Obteniendo datos del mes actual...")
    datos_mes = obtener_datos_multiples(mis_acciones)
    
    print(f"\nüìä Resumen:")
    print(f"Acciones obtenidas: {list(datos_mes.keys())}")
    
    # Mostrar datos de una acci√≥n como ejemplo
    if "AAPL" in datos_mes:
        print(f"\nüìà Datos de AAPL (mes actual):")
        print(datos_mes["AAPL"][['open', 'high', 'low', 'close', 'volume']])
