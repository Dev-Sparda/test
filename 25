def run_pipeline(root_window):
    """
    Ejecuta todo el pipeline de generaci√≥n de reportes.
    root_window: necesario para filedialog desde una app CTk.
    """
    conn = sqlite3.connect(DB_PATH)

    try:
        # 1. Cargar movimientos y unir con cat√°logo para obtener CLAVE_BANXICO
        df_mov = pd.read_sql("""
            SELECT 
                m.CONTRAPARTE,
                m.EMISION,
                m.TITULOS,
                m.ISIN,
                m.ENVIO_RECEPCION,
                c.CLAVE_BANXICO
            FROM MOVIMIENTOS m
            LEFT JOIN CAT_CONTRAPARTES c ON m.CONTRAPARTE = c.CONTRAPARTE
        """, conn)

        if df_mov.empty:
            messagebox.showwarning("Advertencia", "No hay movimientos cargados.")
            return

        # Asegurar que TITULOS sea num√©rico
        df_mov['TITULOS'] = pd.to_numeric(df_mov['TITULOS'], errors='coerce')

        # 2. Agrupar por CLAVE_BANXICO + EMISION (no por CONTRAPARTE)
        df_agrupado = df_mov.groupby(['CLAVE_BANXICO', 'EMISION'], as_index=False).agg({
            'TITULOS': 'sum',
            'ISIN': 'first',
            'ENVIO_RECEPCION': 'first'
        })

        # 3. Eliminar posiciones neteadas a cero
        df_agrupado = df_agrupado[df_agrupado['TITULOS'] != 0].copy()



        if df_agrupado.empty:
            messagebox.showinfo("Informaci√≥n", "No hay posiciones abiertas (todo neteado a cero).")
            return

        # 4. Volver a unir con CAT_CONTRAPARTES para recuperar CONTRAPARTE
        # (por si hay m√°s de una contraparte por CLAVE_BANXICO, tomamos la primera)
        df_final = df_agrupado.merge(
            df_mov[['CLAVE_BANXICO', 'CONTRAPARTE']].drop_duplicates(),
            on='CLAVE_BANXICO',
            how='left'
        )

        # 5. Clasificar como nacional o extranjero
        df_final['TIPO'] = df_final['EMISION'].apply(classify_emision)
        total_titulos = df_final['TITULOS'].sum()
        messagebox.showinfo("Total", f"Suma total de t√≠tulos (neto): {total_titulos:,}")



import pandas as pd
import requests
import json

def yahoo_finance_directo(symbol="AAPL"):
    """
    Yahoo Finance directo - sin librer√≠as externas
    """
    try:
        url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}"
        params = {
            'range': '1mo',
            'interval': '1d'
        }
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
        
        print(f"üì° Conectando a Yahoo Finance para {symbol}...")
        response = requests.get(url, params=params, headers=headers, timeout=15, verify=False)
        
        if response.status_code == 200:
            data = response.json()
            
            if 'chart' in data and 'result' in data['chart']:
                result = data['chart']['result'][0]
                
                # Extraer timestamps y precios
                timestamps = result['timestamp']
                quotes = result['indicators']['quote'][0]
                
                # Crear DataFrame
                df = pd.DataFrame({
                    'date': pd.to_datetime(timestamps, unit='s'),
                    'open': quotes['open'],
                    'high': quotes['high'], 
                    'low': quotes['low'],
                    'close': quotes['close'],
                    'volume': quotes['volume']
                })
                
                df.set_index('date', inplace=True)
                df = df.dropna()  # Remover valores nulos
                df = df.sort_index(ascending=False)
                
                print(f"‚úÖ Yahoo Finance: {len(df)} registros de {symbol}")
                return df
            else:
                print("‚ùå No se pudieron extraer datos del response")
                return None
        else:
            print(f"‚ùå Error HTTP: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"üí• Error: {e}")
        return None

# Probar Yahoo Finance directo
df_yahoo = yahoo_finance_directo("AAPL")
if df_yahoo is not None:
    print(df_yahoo.head())
